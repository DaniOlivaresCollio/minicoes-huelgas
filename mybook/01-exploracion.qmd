# Exploración y Preparación de datos

<div style="text-align: justify">

```{r cargar-paquetes-2,echo=FALSE,warning=FALSE,message=FALSE}
rm(list=ls())

library(pacman)
p_load(tidyverse,
       knitr,
       bookdown,
       car,
       sjmisc,
       sjPlot,
       sjlabelled,
       psych,
       kableExtra,
       gridExtra,
       lubridate,
       viridis,
       statar,
       readxl,
       tinytex,
       ggrepel,
       ggalluvial,
       survey, 
       httr,
       # devtools,
       readr, 
       ggplot2, 
       labelled)

# devtools::install_github("DiogoFerrari/occupar",dependencies=F)
```

```{r datos-2,echo=FALSE}
load("../input/data/ELSOC_Long.RData")
```

Primero, se realiza una revisión exploratoria de las variables de interés, considerando todas las olas de la base de datos, tanto para la muestra original como la de refresco, sin ponderar.

```{r seleccion}
# Seleccion solo para mirar, aun sin ponderadores
data <- elsoc_long_2016_2022 %>%
  select(idencuesta,ola,ola_w01,ola_w02,ola_w03,         # identificacion
         ola_w04,ola_w05,ola_w06,version,muestra,        # identificacion
         sexo=m0_sexo,edad=m0_edad,educ=m01,             # caract sociodemografica
         m02,m06,m07,m08,m10,                            # caract sociodemografica
         m03,ciuo88_m03,ciuo08_m03,                      # caract ocupacional
         m04,ciiu3_m04,ciiu4_m04,                        # caract ocupacional
         c12_04,                                         # membresia sindicato
         c08_03,                                         # freq participa huelgas
         mov_valora=c20,mov_valora_otro=c20_otro,        # mov que mas valora
         c21_01,c21_02,c21_03,c21_04,c21_05,c21_06,      # caract mov valora
         c21_07,c21_08,c21_09,c21_10,c21_11,c22,c23,c24, # caract mov valora
         c13,c14_01,c14_02                               # interes politica
         )
```

Se comienza con 18.035 observaciones.

```{r}
dim(data)
```


## Caracterización empleo

### Actividad principal

-   m02. ¿Cuál de estas situaciones describe mejor su actividad principal durante el último mes?

```{r,echo=FALSE}
# Recodficar
data$actividad <- car::recode(data$m02,
                              recodes=c("1='Trabaja de manera remunerada con jornada completa';
                                         2='Trabaja de manera remunerada a tiempo parcial';
                                         3='Estudia y trabaja';
                                         4='Solo estudia';
                                         5='Jubilado o pensionado';
                                         6='Desempleado, buscando trabajo';
                                         7='Realiza tareas no remuneradas';
                                         8='Esta enfermo o tiene una discapacidad';
                                         9='No estudia, no trabaja y no busca trabajo';
                                         -888=NA; 
                                         -999=NA"),
                              as.factor=TRUE, 
                              levels=c("Trabaja de manera remunerada con jornada completa",
                                       "Trabaja de manera remunerada a tiempo parcial",
                                       "Estudia y trabaja",
                                       "Solo estudia",
                                       "Jubilado o pensionado",
                                       "Desempleado, buscando trabajo",
                                       "Realiza tareas no remuneradas",
                                       "Esta enfermo o tiene una discapacidad",
                                       "No estudia, no trabaja y no busca trabajo"))

# Tabla de frecuencias y porcentajes
sjt.xtab(data$actividad, data$ola,
         show.col.prc = TRUE, 
         var.labels = c("Actividad","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes de Actividad principal, por ola") 
```

Se continua con una base de datos filtrada dejando solo a las personas ocupadas de acuerdo con las siguientes categorías de actividad principal:

- m02==1: Trabaja de manera remunerada con jornada completa
- m02==2: Trabaja de manera remunerada a tiempo parcial
- m03==3: Estudia y trabaja

```{r, echo=FALSE}
# Filtrar para ocupados
data <- filter(data, actividad %in% c("Trabaja de manera remunerada con jornada completa",
                                      "Trabaja de manera remunerada a tiempo parcial",
                                      "Estudia y trabaja"))
```

```{r}
dim(data)
```

Quedan 11078 observaciones.

### Relación de empleo

-   m07. En su actual ocupación usted trabaja como:

```{r,echo=FALSE}
# Recodficar
data <- data %>%
  mutate(rel_empleo=car::recode(m07,
                                recodes=c("1='Empleado u obrero en empresa privada';
                                           2='Empleado u obrero del sector público';
                                           3='Miembro de las Fuerzas Armadas y de Orden';
                                           4='Patrón/a o empleador/a';
                                           5='Trabaja solo, no tiene empleados';
                                           6='Familiar no remunerado';
                                           7='Servicio doméstico';
                                           -888=NA; 
                                           -999=NA"),
                                as.factor=TRUE, # convertir a factor
                                levels=c("Empleado u obrero en empresa privada",
                                         "Empleado u obrero del sector público",
                                         "Miembro de las Fuerzas Armadas y de Orden",
                                         "Patrón/a o empleador/a",
                                         "Trabaja solo, no tiene empleados",
                                         "Familiar no remunerado",
                                         "Servicio doméstico"))) # ordenar niveles

# Tabla de frecuencias y porcentajes 2 dígitos
sjt.xtab(data$rel_empleo, data$ola,
         show.col.prc = TRUE,
         var.labels = c("Relación de empleo","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes de la Relación de empleo, por ola")
```

### Ocupación

-   m03. ¿Cuál es su ocupación u oficio actual? Describa sus principales tareas y funciones en el puesto de trabajo actual

Esta variable se encuentra codificada de acuerdo con la CIUO88 para el año 2016, y CIUO08 para los años 2018 y 2021.

-   ciuo88_m03: CIUO (1988) del entrevistado
-   ciuo08_m03: CIUO (2008) del entrevistado

Por lo tanto, se realiza una recodificación generando una nueva variable donde están todas las olas homolagadas a la CIUO08. Se presentan las frecuecnias y porcentajes con uno y dos dígitos.

```{r,echo=FALSE,message=FALSE,warning=FALSE}
# Carga bbdd con comparacion 88 y 08
isco08_88 <- read_excel("../input/isco08-88.xls")
isco08_88 <- isco08_88 %>%
  rename(isco08=`ISCO 08 Code`,isco88=`ISCO-88 code`)

# Exploración
valores_repetidos <- table(isco08_88$isco88) # Contar los valores repetidos en la variable
valores_repetidos <- valores_repetidos[valores_repetidos > 1]

valores_repetidos <- table(isco08_88$isco08) # Contar los valores repetidos en la variable
valores_repetidos <- valores_repetidos[valores_repetidos > 1]

# CIUO - ISCO: Recodificación 88->08 4 digitos en datos elsoc
indices <- match(data$ciuo88_m03,isco08_88$isco88)
data$ciuo08_rec <- isco08_88$isco08[indices]
data$ciuo08_rec <- as.numeric(data$ciuo08_rec) # es solo la recodificación de las que eran 88 en data, es decir, año 2016

# Creación variable isco08 con ciuo08_m03 y ciuo08_rec (ex ciuo88_m03) 4 digitos
data$isco08 <- ifelse(!is.na(data$ciuo08_rec),data$ciuo08_rec,data$ciuo08_m03) # es la unión en una variable de todo en 08

# CIUO - ISCO: creación de variables con 1 dígito
data$isco08_1d <- as.character(data$isco08)
data$isco08_1d <- substr(data$isco08_1d,1,1)
data$isco08_1d <- as.numeric(data$isco08_1d)

# CIUO - ISCO: creación de variables con 2 dígitos
data$isco08_2d <- as.character(data$isco08)
data$isco08_2d <- substr(data$isco08_2d,1,2)
data$isco08_2d <- as.numeric(data$isco08_2d)

# Tabla de frecuencias y porcentajes 1 dígito
sjt.xtab(data$isco08_1d, data$ola,
         show.col.prc = TRUE, 
         var.labels = c("CIUO08","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes de Ocupación con 1 dígito, por ola")

# Tabla de frecuencias y porcentajes 2 dígitos
sjt.xtab(data$isco08_2d, data$ola,
         show.col.prc = TRUE, 
         var.labels = c("CIUO08","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes de Ocupación con 2 dígitos, por ola")
```

### Nivel de cualificación

Se crea una nueva variable con el Nivel de cualificación, de acuerdo con la variable CIUO08 de 2 dígitos *isco08_2d*, siguiendo el criterio:

- Expertos (Experts): 11 a 34 con universitaria completa o más 
- Calificados (Skilled): 11 a 34 con universitaria incompleta o menos, y 35,41,42,43,44,53, y 51,54,61,62,71,72,73,74,75,81 con media completa o más.
- No calificados (Unskilled): 51,54,61,62,71,72,73,74,75,81 con media incompleta o menos, y 52,61,63,75,82,83,90+ 

```{r,echo=FALSE}
# Creación variable Nivel de cualificación
data <- mutate(data,
               cualificacion = case_when(isco08_2d <= 34 & educ >= 9 ~ "Experts",
                                         isco08_2d <= 34 & educ < 9 ~ "Skilled",
                                         isco08_2d == 35 ~ "Skilled",
                                         isco08_2d >= 41 & isco08_2d <= 44 ~ "Skilled",
                                         isco08_2d == 53 ~ "Skilled",
                                         isco08_2d == 51 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 51 & educ > 5 ~ "Skilled",
                                         isco08_2d == 54 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 54 & educ > 5 ~ "Skilled",
                                         isco08_2d == 61 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 61 & educ > 5 ~ "Skilled",
                                         isco08_2d == 62 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 62 & educ > 5 ~ "Skilled",
                                         isco08_2d == 71 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 71 & educ > 5 ~ "Skilled",
                                         isco08_2d == 72 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 72 & educ > 5 ~ "Skilled",
                                         isco08_2d == 73 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 73 & educ > 5 ~ "Skilled",
                                         isco08_2d == 74 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 74 & educ > 5 ~ "Skilled",
                                         isco08_2d == 75 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 75 & educ > 5 ~ "Skilled",
                                         isco08_2d == 81 & educ <= 5 ~ "Unskilled",
                                         isco08_2d == 81 & educ > 5 ~ "Skilled",
                                         isco08_2d == 52 ~ "Unskilled",
                                         isco08_2d == 61 ~ "Unskilled",
                                         isco08_2d == 63 ~ "Unskilled",
                                         isco08_2d == 75 ~ "Unskilled",
                                         isco08_2d == 82 ~ "Unskilled",
                                         isco08_2d == 83 ~ "Unskilled",
                                         isco08_2d == 90 ~ "Unskilled"))

# Tabla de frecuencias y porcentajes 2 dígitos
sjt.xtab(data$cualificacion, data$ola,
         show.col.prc = TRUE, 
         var.labels = c("Nivel de cualificación","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes del Nivel de Cualificación, por ola")
```


### Supervisión 

-   m06. En su trabajo, ¿a cuántas personas supervisa usted?

Se recodifica en una nueva variable donde:

- 1 = supervisa a una o más personas
- 0 = no supervisa

```{r,echo=FALSE}
# Crear variable supervisa==1, no supervisa==0
data <- data %>%
  mutate(supervisa=case_when(m06 == 0 ~ 0,
                             m06 >= 1 ~ 1,
                             m06 == -888 ~ NA,
                             m06 == -999 ~ NA))

# Tabla de frecuencias y porcentajes 2 dígitos
sjt.xtab(data$supervisa, data$ola,
         show.col.prc = TRUE, 
         var.labels = c("Supervisa","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes de variable Supervisa, por ola")
```

### Class

Se crea la variable posición de clase (class) con 7 categorías:

1. Self-employed
2. Expert managers: expertos que supervisan
3. Experts: expertos que no supervisan
4. Skilled supervisors: skilled que supervisan
5. Skilled workers: skilled que no supervisan
6. Unskilled supervisors: unskilled que supervisan
7. Workers: skilled que no supervisan

```{r,echo=FALSE}
# Creación de variable posición de clase
data <- mutate(data,
               class=case_when(rel_empleo == "Trabaja solo, no tiene empleados" ~ "Self-employed",
                               cualificacion == "Experts" & supervisa == 1 ~ "Expert managers",
                               cualificacion == "Experts" & supervisa == 0 ~ "Experts",
                               cualificacion == "Skilled" & supervisa == 1 ~ "Skilled supervisors",
                               cualificacion == "Skilled" & supervisa == 0 ~ "Skilled workers",
                               cualificacion == "Unskilled" & supervisa == 1 ~ "Unskilled supervisors",
                               cualificacion == "Unskilled" & supervisa == 0 ~ "Workers"))

data$class <- factor(data$class,
                     levels = c("Self-employed",
                                "Expert managers",
                                "Experts",
                                "Skilled supervisors",
                                "Skilled workers",
                                "Unskilled supervisors",
                                "Workers"))

# Tabla de frecuencias y porcentajes 2 dígitos
sjt.xtab(data$class, data$ola,
         show.col.prc = TRUE, 
         var.labels = c("Posición de clase","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes de la Posición de clase, por ola")
```

Class 2: 

- Se unen *Skilled supervisors* y *Unskilled supervisors*
- Se unen *Skilled workers* y *Workers*

```{r,echo=FALSE}
# Creación de variable posición de clase
data <- mutate(data,
               class_2=case_when(class == "Self-employed" ~ "Self-employed",
                                 class == "Expert managers" ~ "Expert managers",
                                 class == "Experts" ~ "Experts",
                                 class == "Skilled supervisors" | class == "Unskilled supervisors" ~ "Supervisors",
                                 class == "Skilled workers" | class == "Workers" ~ "Workers"))

data$class_2 <- factor(data$class_2,
                       levels = c("Self-employed",
                                  "Expert managers",
                                  "Experts",
                                  "Supervisors",
                                  "Workers"))

# Tabla de frecuencias y porcentajes 2 dígitos
sjt.xtab(data$class_2, data$ola,
         show.col.prc = TRUE, 
         var.labels = c("Posición de clase 2","Ola"),
         show.summary = FALSE,
         title = "Frecuencias y porcentajes de la Posición de clase 2, por ola")
```

